---
tags:
  - 技术/NET
---
## 反射的缺点

反射是非常强大的机制，允许在运行时发现并使用编译时还不了解的类型及成员。但是，反射有以下两个缺点：

- 反射造成编译时无法保证类型安全性。由于反射严重依赖字符串，所以会丧失编译时的类型安全性。例如，执行 `Type.GetType("int")`要求通过反射在程序集中查找名为 `int`  的类型，代码会通过编译，但在运行时会返回 `null` ，因为 CLR 只知 `System.Int32` 而不是 `int` 。

- 反射速度慢。使用反射时，类型及其成员的名称在编译时未知，需要使用字符串名称标识每个类型及成员，然后在运行时发现他们。也就是说，使用 `System.Reflection` 命名空间中的类型扫描程序集的元数据时，反射机制会不停的执行字符串搜索。通常，字符串执行搜索的是不区分大小写的比较，会进一步影响速度。

使用反射调用成员也会影响性能。用反射调用方法时，首先必须将实参打包(pack)成数组；在内部，反射必须将这些实参解包(unpack)到线程栈上。此外，在调用方法前，CLR必须确保调用者有正确的安全权限来访问被调用的成员。最后，CLR 必须确保调用者有正确的安全权限来访问被调用的成员。

## 避免使用反射

最好避免使用反射来访问字段或调用方法/属性。应该利用以下两种技术之一开发应用程序来动态发现和构造类型实例。

- 让类型从编译时已知的基类型派生。在运行时构造派生类的实例，将对它的引用放到基类型的变量中（利用转型），再调用接口定义的虚方法。

- 让类型实现编译时已知的接口。在运行时构造类型的实例，将对他的引用放到接口类型的变量中（利用转型），再调用接口定义的方法。
